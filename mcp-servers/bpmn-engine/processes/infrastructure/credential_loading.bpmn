<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions
    xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    targetNamespace="http://claude-family/bpmn/credential-loading"
    id="Definitions_CL">

  <bpmn:process id="credential_loading" name="Credential Loading" isExecutable="true">

    <!--
      Credential loading pipeline used by MCP servers and hook scripts when
      establishing a PostgreSQL connection.

      Priority order for env files:
        1. scripts/.env  (project-specific, takes precedence)
        2. project root .env
        3. shared ~/.env
        4. legacy locations

      Priority order for connection URI:
        1. DATABASE_URI
        2. DATABASE_URL
        3. POSTGRES_CONNECTION_STRING
        4. Built from POSTGRES_CONFIG dict (host/port/dbname/user/password)

      Driver detection:
        - Try psycopg (v3) first
        - Fall back to psycopg2 (v2)
        - If neither available: driver_available = False

      Three failure points, each with strict/graceful branches:
        A. No driver found
        B. No URI resolved
        C. Connection attempt failed

      Strict mode: propagate the error (caller raises)
      Graceful mode: return None / log warning (caller handles gracefully)

      Implementation: mcp-servers/project-tools/server_v2.py (connect_db)
      Also used by: scripts/session_startup_hook_enhanced.py, scripts/rag_query_hook.py
    -->

    <!-- ================================================================== -->
    <!-- START                                                               -->
    <!-- ================================================================== -->

    <bpmn:startEvent id="start_load" name="Credential Load Requested">
      <bpmn:outgoing>flow_start_to_load_env</bpmn:outgoing>
    </bpmn:startEvent>

    <!-- ================================================================== -->
    <!-- PHASE 1: LOAD ENV FILES                                             -->
    <!-- ================================================================== -->

    <bpmn:scriptTask id="load_env_files" name="[FILE] Load .env Files (Priority Order)" scriptFormat="python">
      <bpmn:incoming>flow_start_to_load_env</bpmn:incoming>
      <bpmn:outgoing>flow_load_env_to_detect</bpmn:outgoing>
      <bpmn:script>
# Load .env files in priority order (later loads do NOT override earlier ones):
#   1. scripts/.env         (project-specific credentials)
#   2. {project_root}/.env  (project root)
#   3. ~/.env               (shared / user-level)
#   4. legacy locations     (backward compatibility)
# dotenv load_dotenv(override=False) per file, highest-priority first
env_loaded = True
      </bpmn:script>
    </bpmn:scriptTask>

    <!-- ================================================================== -->
    <!-- PHASE 2: DETECT PSYCOPG DRIVER                                     -->
    <!-- ================================================================== -->

    <bpmn:scriptTask id="detect_psycopg" name="[ENV] Detect psycopg Driver (v3 → v2 → unavailable)" scriptFormat="python">
      <bpmn:incoming>flow_load_env_to_detect</bpmn:incoming>
      <bpmn:outgoing>flow_detect_to_driver_gw</bpmn:outgoing>
      <bpmn:script>
# Try psycopg (v3) first — preferred, async-capable
# Fall back to psycopg2 (v2) — synchronous, widely installed
# If neither importable: driver_available = False, psycopg_version = 0
# force_no_driver flag overrides for testing
try:
    if force_no_driver:
        driver_available = False
        psycopg_version = 0
    else:
        driver_available = True
        psycopg_version = 3
except NameError:
    driver_available = True
    psycopg_version = 3
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:exclusiveGateway id="gw_driver_available" name="Driver Available?" default="flow_no_driver">
      <bpmn:incoming>flow_detect_to_driver_gw</bpmn:incoming>
      <bpmn:outgoing>flow_driver_ok</bpmn:outgoing>
      <bpmn:outgoing>flow_no_driver</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- ================================================================== -->
    <!-- FAILURE PATH A: NO DRIVER                                          -->
    <!-- ================================================================== -->

    <bpmn:scriptTask id="handle_no_driver" name="[LOG] Log: No psycopg Driver Found" scriptFormat="python">
      <bpmn:incoming>flow_no_driver</bpmn:incoming>
      <bpmn:outgoing>flow_no_driver_to_strict_gw</bpmn:outgoing>
      <bpmn:script>
# Log warning: psycopg and psycopg2 both unavailable
# Caller must install one: pip install psycopg[binary] or pip install psycopg2-binary
error_reason = "no_driver"
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:exclusiveGateway id="gw_strict_no_driver" name="Strict Mode?" default="flow_no_driver_graceful">
      <bpmn:incoming>flow_no_driver_to_strict_gw</bpmn:incoming>
      <bpmn:outgoing>flow_no_driver_strict</bpmn:outgoing>
      <bpmn:outgoing>flow_no_driver_graceful</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:endEvent id="end_no_driver_strict" name="Error: No Driver (Strict)">
      <bpmn:incoming>flow_no_driver_strict</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="end_no_driver_graceful" name="None: No Driver (Graceful)">
      <bpmn:incoming>flow_no_driver_graceful</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ================================================================== -->
    <!-- PHASE 3: RESOLVE CONNECTION URI                                     -->
    <!-- ================================================================== -->

    <bpmn:scriptTask id="resolve_uri" name="[ENV] Resolve Connection URI (DATABASE_URI → build)" scriptFormat="python">
      <bpmn:incoming>flow_driver_ok</bpmn:incoming>
      <bpmn:outgoing>flow_resolve_to_uri_gw</bpmn:outgoing>
      <bpmn:script>
# Check env vars in priority order:
#   1. DATABASE_URI                 (canonical name)
#   2. DATABASE_URL                 (common alias)
#   3. POSTGRES_CONNECTION_STRING   (legacy alias)
#   4. Build from POSTGRES_CONFIG dict {host, port, dbname, user, password}
# force_no_uri flag overrides for testing
try:
    if force_no_uri:
        uri_resolved = False
        connection_uri = None
    else:
        uri_resolved = True
        connection_uri = "postgresql://user:pass@localhost:5432/ai_company_foundation"
except NameError:
    uri_resolved = True
    connection_uri = "postgresql://user:pass@localhost:5432/ai_company_foundation"
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:exclusiveGateway id="gw_uri_found" name="URI Resolved?" default="flow_no_uri">
      <bpmn:incoming>flow_resolve_to_uri_gw</bpmn:incoming>
      <bpmn:outgoing>flow_uri_ok</bpmn:outgoing>
      <bpmn:outgoing>flow_no_uri</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- ================================================================== -->
    <!-- FAILURE PATH B: NO URI                                             -->
    <!-- ================================================================== -->

    <bpmn:scriptTask id="handle_no_uri" name="[LOG] Log: No Connection URI Found" scriptFormat="python">
      <bpmn:incoming>flow_no_uri</bpmn:incoming>
      <bpmn:outgoing>flow_no_uri_to_strict_gw</bpmn:outgoing>
      <bpmn:script>
# Log warning: no DATABASE_URI, DATABASE_URL, POSTGRES_CONNECTION_STRING, or POSTGRES_CONFIG found
# Caller should set one of the above env vars or POSTGRES_CONFIG dict
error_reason = "no_uri"
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:exclusiveGateway id="gw_strict_no_uri" name="Strict Mode?" default="flow_no_uri_graceful">
      <bpmn:incoming>flow_no_uri_to_strict_gw</bpmn:incoming>
      <bpmn:outgoing>flow_no_uri_strict</bpmn:outgoing>
      <bpmn:outgoing>flow_no_uri_graceful</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:endEvent id="end_no_uri_strict" name="Error: No URI (Strict)">
      <bpmn:incoming>flow_no_uri_strict</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="end_no_uri_graceful" name="None: No URI (Graceful)">
      <bpmn:incoming>flow_no_uri_graceful</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ================================================================== -->
    <!-- PHASE 4: ATTEMPT CONNECTION                                         -->
    <!-- ================================================================== -->

    <bpmn:scriptTask id="attempt_connection" name="[DB] Attempt PostgreSQL Connection" scriptFormat="python">
      <bpmn:incoming>flow_uri_ok</bpmn:incoming>
      <bpmn:outgoing>flow_connect_to_gw</bpmn:outgoing>
      <bpmn:script>
# Connect using the resolved URI with the detected psycopg version:
#   psycopg v3: psycopg.connect(connection_uri)
#   psycopg v2: psycopg2.connect(connection_uri)
# force_connection_fail flag overrides for testing
try:
    if force_connection_fail:
        connection_success = False
        connection_error = "forced failure for testing"
    else:
        connection_success = True
        connection_error = None
except NameError:
    connection_success = True
    connection_error = None
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:exclusiveGateway id="gw_connected" name="Connection Succeeded?" default="flow_conn_failed">
      <bpmn:incoming>flow_connect_to_gw</bpmn:incoming>
      <bpmn:outgoing>flow_conn_ok</bpmn:outgoing>
      <bpmn:outgoing>flow_conn_failed</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- ================================================================== -->
    <!-- FAILURE PATH C: CONNECTION FAILED                                  -->
    <!-- ================================================================== -->

    <bpmn:scriptTask id="handle_connection_fail" name="[LOG] Log: Connection Failed" scriptFormat="python">
      <bpmn:incoming>flow_conn_failed</bpmn:incoming>
      <bpmn:outgoing>flow_conn_fail_to_strict_gw</bpmn:outgoing>
      <bpmn:script>
# Log warning: connection attempt failed with connection_error message
# Common causes: wrong credentials, DB not running, network unreachable
error_reason = "connection_failed"
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:exclusiveGateway id="gw_strict_conn_fail" name="Strict Mode?" default="flow_conn_fail_graceful">
      <bpmn:incoming>flow_conn_fail_to_strict_gw</bpmn:incoming>
      <bpmn:outgoing>flow_conn_fail_strict</bpmn:outgoing>
      <bpmn:outgoing>flow_conn_fail_graceful</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:endEvent id="end_conn_fail_strict" name="Error: Connection Failed (Strict)">
      <bpmn:incoming>flow_conn_fail_strict</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="end_conn_fail_graceful" name="None: Connection Failed (Graceful)">
      <bpmn:incoming>flow_conn_fail_graceful</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ================================================================== -->
    <!-- SUCCESS                                                             -->
    <!-- ================================================================== -->

    <bpmn:endEvent id="end_success" name="Connection Established">
      <bpmn:incoming>flow_conn_ok</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ================================================================== -->
    <!-- SEQUENCE FLOWS                                                      -->
    <!-- ================================================================== -->

    <!-- Phase 1: Load env files -->
    <bpmn:sequenceFlow id="flow_start_to_load_env" sourceRef="start_load" targetRef="load_env_files"/>
    <bpmn:sequenceFlow id="flow_load_env_to_detect" sourceRef="load_env_files" targetRef="detect_psycopg"/>

    <!-- Phase 2: Driver detection -->
    <bpmn:sequenceFlow id="flow_detect_to_driver_gw" sourceRef="detect_psycopg" targetRef="gw_driver_available"/>
    <bpmn:sequenceFlow id="flow_driver_ok" sourceRef="gw_driver_available" targetRef="resolve_uri">
      <bpmn:conditionExpression>driver_available == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="flow_no_driver" sourceRef="gw_driver_available" targetRef="handle_no_driver"/>

    <!-- Failure path A: No driver -->
    <bpmn:sequenceFlow id="flow_no_driver_to_strict_gw" sourceRef="handle_no_driver" targetRef="gw_strict_no_driver"/>
    <bpmn:sequenceFlow id="flow_no_driver_strict" sourceRef="gw_strict_no_driver" targetRef="end_no_driver_strict">
      <bpmn:conditionExpression>strict_mode == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="flow_no_driver_graceful" sourceRef="gw_strict_no_driver" targetRef="end_no_driver_graceful"/>

    <!-- Phase 3: Resolve URI -->
    <bpmn:sequenceFlow id="flow_resolve_to_uri_gw" sourceRef="resolve_uri" targetRef="gw_uri_found"/>
    <bpmn:sequenceFlow id="flow_uri_ok" sourceRef="gw_uri_found" targetRef="attempt_connection">
      <bpmn:conditionExpression>uri_resolved == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="flow_no_uri" sourceRef="gw_uri_found" targetRef="handle_no_uri"/>

    <!-- Failure path B: No URI -->
    <bpmn:sequenceFlow id="flow_no_uri_to_strict_gw" sourceRef="handle_no_uri" targetRef="gw_strict_no_uri"/>
    <bpmn:sequenceFlow id="flow_no_uri_strict" sourceRef="gw_strict_no_uri" targetRef="end_no_uri_strict">
      <bpmn:conditionExpression>strict_mode == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="flow_no_uri_graceful" sourceRef="gw_strict_no_uri" targetRef="end_no_uri_graceful"/>

    <!-- Phase 4: Attempt connection -->
    <bpmn:sequenceFlow id="flow_connect_to_gw" sourceRef="attempt_connection" targetRef="gw_connected"/>
    <bpmn:sequenceFlow id="flow_conn_ok" sourceRef="gw_connected" targetRef="end_success">
      <bpmn:conditionExpression>connection_success == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="flow_conn_failed" sourceRef="gw_connected" targetRef="handle_connection_fail"/>

    <!-- Failure path C: Connection failed -->
    <bpmn:sequenceFlow id="flow_conn_fail_to_strict_gw" sourceRef="handle_connection_fail" targetRef="gw_strict_conn_fail"/>
    <bpmn:sequenceFlow id="flow_conn_fail_strict" sourceRef="gw_strict_conn_fail" targetRef="end_conn_fail_strict">
      <bpmn:conditionExpression>strict_mode == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="flow_conn_fail_graceful" sourceRef="gw_strict_conn_fail" targetRef="end_conn_fail_graceful"/>

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="credential_loading">
      <bpmndi:BPMNShape id="s_start_load" bpmnElement="start_load">
        <dc:Bounds x="50" y="240" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_load_env_files" bpmnElement="load_env_files">
        <dc:Bounds x="140" y="220" width="140" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_detect_psycopg" bpmnElement="detect_psycopg">
        <dc:Bounds x="340" y="220" width="140" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_gw_driver_available" bpmnElement="gw_driver_available" isMarkerVisible="true">
        <dc:Bounds x="540" y="233" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <!-- Failure path A: No driver -->
      <bpmndi:BPMNShape id="s_handle_no_driver" bpmnElement="handle_no_driver">
        <dc:Bounds x="640" y="100" width="140" height="60"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_gw_strict_no_driver" bpmnElement="gw_strict_no_driver" isMarkerVisible="true">
        <dc:Bounds x="840" y="113" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_end_no_driver_strict" bpmnElement="end_no_driver_strict">
        <dc:Bounds x="950" y="73" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_end_no_driver_graceful" bpmnElement="end_no_driver_graceful">
        <dc:Bounds x="950" y="153" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <!-- Phase 3: Resolve URI -->
      <bpmndi:BPMNShape id="s_resolve_uri" bpmnElement="resolve_uri">
        <dc:Bounds x="640" y="220" width="140" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_gw_uri_found" bpmnElement="gw_uri_found" isMarkerVisible="true">
        <dc:Bounds x="840" y="233" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <!-- Failure path B: No URI -->
      <bpmndi:BPMNShape id="s_handle_no_uri" bpmnElement="handle_no_uri">
        <dc:Bounds x="940" y="100" width="140" height="60"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_gw_strict_no_uri" bpmnElement="gw_strict_no_uri" isMarkerVisible="true">
        <dc:Bounds x="1140" y="113" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_end_no_uri_strict" bpmnElement="end_no_uri_strict">
        <dc:Bounds x="1250" y="73" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_end_no_uri_graceful" bpmnElement="end_no_uri_graceful">
        <dc:Bounds x="1250" y="153" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <!-- Phase 4: Attempt connection -->
      <bpmndi:BPMNShape id="s_attempt_connection" bpmnElement="attempt_connection">
        <dc:Bounds x="940" y="220" width="140" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_gw_connected" bpmnElement="gw_connected" isMarkerVisible="true">
        <dc:Bounds x="1140" y="233" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <!-- Failure path C: Connection failed -->
      <bpmndi:BPMNShape id="s_handle_connection_fail" bpmnElement="handle_connection_fail">
        <dc:Bounds x="1240" y="340" width="140" height="60"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_gw_strict_conn_fail" bpmnElement="gw_strict_conn_fail" isMarkerVisible="true">
        <dc:Bounds x="1440" y="353" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_end_conn_fail_strict" bpmnElement="end_conn_fail_strict">
        <dc:Bounds x="1550" y="313" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="s_end_conn_fail_graceful" bpmnElement="end_conn_fail_graceful">
        <dc:Bounds x="1550" y="393" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <!-- Success -->
      <bpmndi:BPMNShape id="s_end_success" bpmnElement="end_success">
        <dc:Bounds x="1250" y="240" width="36" height="36"/>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
