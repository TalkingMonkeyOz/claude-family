<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions
    xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
    targetNamespace="http://claude-family/bpmn/hook-chain"
    id="Definitions_HookChain">

  <bpmn:process id="hook_chain" name="Hook Chain" isExecutable="true">

    <!-- Start Event -->
    <bpmn:startEvent id="start_event" name="Start">
      <bpmn:outgoing>flow_start_to_receive</bpmn:outgoing>
    </bpmn:startEvent>

    <!-- User Task: Receive Prompt -->
    <bpmn:userTask id="receive_prompt" name="Receive Prompt">
      <bpmn:incoming>flow_start_to_receive</bpmn:incoming>
      <bpmn:outgoing>flow_receive_to_rag</bpmn:outgoing>
    </bpmn:userTask>

    <!-- Script Task: RAG Query -->
    <bpmn:scriptTask id="rag_query" name="RAG Query" scriptFormat="python">
      <bpmn:incoming>flow_receive_to_rag</bpmn:incoming>
      <bpmn:outgoing>flow_rag_to_gateway</bpmn:outgoing>
      <bpmn:script>rag_executed = True</bpmn:script>
    </bpmn:scriptTask>

    <!-- Exclusive Gateway: Is Tool Call? -->
    <bpmn:exclusiveGateway id="is_tool_call_gateway" name="Is Tool Call?" default="flow_no_tool">
      <bpmn:incoming>flow_rag_to_gateway</bpmn:incoming>
      <bpmn:outgoing>flow_is_tool_call</bpmn:outgoing>
      <bpmn:outgoing>flow_no_tool</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- Script Task: Check Discipline -->
    <bpmn:scriptTask id="check_discipline" name="Check Discipline" scriptFormat="python">
      <bpmn:incoming>flow_is_tool_call</bpmn:incoming>
      <bpmn:outgoing>flow_check_to_discipline_result</bpmn:outgoing>
      <bpmn:script>discipline_checked = True</bpmn:script>
    </bpmn:scriptTask>

    <!-- Exclusive Gateway: Discipline Result -->
    <bpmn:exclusiveGateway id="discipline_result_gateway" name="Discipline Result" default="flow_discipline_pass">
      <bpmn:incoming>flow_check_to_discipline_result</bpmn:incoming>
      <bpmn:outgoing>flow_discipline_blocked</bpmn:outgoing>
      <bpmn:outgoing>flow_discipline_pass</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- Script Task: Mark Blocked -->
    <bpmn:scriptTask id="mark_blocked" name="Mark Blocked" scriptFormat="python">
      <bpmn:incoming>flow_discipline_blocked</bpmn:incoming>
      <bpmn:outgoing>flow_mark_blocked_to_end</bpmn:outgoing>
      <bpmn:script>blocked = True</bpmn:script>
    </bpmn:scriptTask>

    <!-- Script Task: Inject Context -->
    <bpmn:scriptTask id="inject_context" name="Inject Context" scriptFormat="python">
      <bpmn:incoming>flow_discipline_pass</bpmn:incoming>
      <bpmn:outgoing>flow_inject_to_execute</bpmn:outgoing>
      <bpmn:script>context_injected = True</bpmn:script>
    </bpmn:scriptTask>

    <!-- User Task: Execute Tool -->
    <bpmn:userTask id="execute_tool" name="Execute Tool">
      <bpmn:incoming>flow_inject_to_execute</bpmn:incoming>
      <bpmn:outgoing>flow_execute_to_sync</bpmn:outgoing>
    </bpmn:userTask>

    <!-- Script Task: Post Tool Sync -->
    <bpmn:scriptTask id="post_tool_sync" name="Post Tool Sync" scriptFormat="python">
      <bpmn:incoming>flow_execute_to_sync</bpmn:incoming>
      <bpmn:outgoing>flow_sync_to_end_tool</bpmn:outgoing>
      <bpmn:script>tool_synced = True</bpmn:script>
    </bpmn:scriptTask>

    <!-- Script Task: Generate Response -->
    <bpmn:scriptTask id="generate_response" name="Generate Response" scriptFormat="python">
      <bpmn:incoming>flow_no_tool</bpmn:incoming>
      <bpmn:outgoing>flow_generate_to_end</bpmn:outgoing>
      <bpmn:script>response_generated = True</bpmn:script>
    </bpmn:scriptTask>

    <!-- End Event: Blocked -->
    <bpmn:endEvent id="end_blocked" name="Blocked">
      <bpmn:incoming>flow_mark_blocked_to_end</bpmn:incoming>
    </bpmn:endEvent>

    <!-- End Event: Tool Complete -->
    <bpmn:endEvent id="end_tool_complete" name="Tool Complete">
      <bpmn:incoming>flow_sync_to_end_tool</bpmn:incoming>
    </bpmn:endEvent>

    <!-- End Event: Response -->
    <bpmn:endEvent id="end_response" name="Response">
      <bpmn:incoming>flow_generate_to_end</bpmn:incoming>
    </bpmn:endEvent>

    <!-- Sequence Flows -->
    <bpmn:sequenceFlow id="flow_start_to_receive" sourceRef="start_event" targetRef="receive_prompt"/>
    <bpmn:sequenceFlow id="flow_receive_to_rag" sourceRef="receive_prompt" targetRef="rag_query"/>
    <bpmn:sequenceFlow id="flow_rag_to_gateway" sourceRef="rag_query" targetRef="is_tool_call_gateway"/>

    <bpmn:sequenceFlow id="flow_is_tool_call" sourceRef="is_tool_call_gateway" targetRef="check_discipline">
      <bpmn:conditionExpression>is_tool_call == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="flow_no_tool" sourceRef="is_tool_call_gateway" targetRef="generate_response"/>

    <bpmn:sequenceFlow id="flow_check_to_discipline_result" sourceRef="check_discipline" targetRef="discipline_result_gateway"/>

    <bpmn:sequenceFlow id="flow_discipline_blocked" sourceRef="discipline_result_gateway" targetRef="mark_blocked">
      <bpmn:conditionExpression>discipline_blocked == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="flow_discipline_pass" sourceRef="discipline_result_gateway" targetRef="inject_context"/>

    <bpmn:sequenceFlow id="flow_mark_blocked_to_end" sourceRef="mark_blocked" targetRef="end_blocked"/>
    <bpmn:sequenceFlow id="flow_inject_to_execute" sourceRef="inject_context" targetRef="execute_tool"/>
    <bpmn:sequenceFlow id="flow_execute_to_sync" sourceRef="execute_tool" targetRef="post_tool_sync"/>
    <bpmn:sequenceFlow id="flow_sync_to_end_tool" sourceRef="post_tool_sync" targetRef="end_tool_complete"/>
    <bpmn:sequenceFlow id="flow_generate_to_end" sourceRef="generate_response" targetRef="end_response"/>

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="hook_chain">

      <!-- Main horizontal lane: y=200 -->
      <bpmndi:BPMNShape id="shape_start_event" bpmnElement="start_event">
        <dc:Bounds x="100" y="200" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_receive_prompt" bpmnElement="receive_prompt">
        <dc:Bounds x="196" y="180" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_rag_query" bpmnElement="rag_query">
        <dc:Bounds x="356" y="180" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_is_tool_call_gateway" bpmnElement="is_tool_call_gateway" isMarkerVisible="true">
        <dc:Bounds x="516" y="193" width="50" height="50"/>
      </bpmndi:BPMNShape>

      <!-- Tool call branch: continues right -->
      <bpmndi:BPMNShape id="shape_check_discipline" bpmnElement="check_discipline">
        <dc:Bounds x="626" y="180" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_discipline_result_gateway" bpmnElement="discipline_result_gateway" isMarkerVisible="true">
        <dc:Bounds x="786" y="193" width="50" height="50"/>
      </bpmndi:BPMNShape>

      <!-- Blocked branch: goes down -->
      <bpmndi:BPMNShape id="shape_mark_blocked" bpmnElement="mark_blocked">
        <dc:Bounds x="761" y="340" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_end_blocked" bpmnElement="end_blocked">
        <dc:Bounds x="921" y="358" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- Allowed branch: continues right -->
      <bpmndi:BPMNShape id="shape_inject_context" bpmnElement="inject_context">
        <dc:Bounds x="896" y="180" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_execute_tool" bpmnElement="execute_tool">
        <dc:Bounds x="1056" y="180" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_post_tool_sync" bpmnElement="post_tool_sync">
        <dc:Bounds x="1216" y="180" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_end_tool_complete" bpmnElement="end_tool_complete">
        <dc:Bounds x="1376" y="200" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- No-tool branch: goes down then right -->
      <bpmndi:BPMNShape id="shape_generate_response" bpmnElement="generate_response">
        <dc:Bounds x="491" y="340" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_end_response" bpmnElement="end_response">
        <dc:Bounds x="651" y="358" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- Edges -->
      <bpmndi:BPMNEdge id="edge_flow_start_to_receive" bpmnElement="flow_start_to_receive">
        <di:waypoint x="136" y="218"/>
        <di:waypoint x="196" y="220"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_receive_to_rag" bpmnElement="flow_receive_to_rag">
        <di:waypoint x="296" y="220"/>
        <di:waypoint x="356" y="220"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_rag_to_gateway" bpmnElement="flow_rag_to_gateway">
        <di:waypoint x="456" y="220"/>
        <di:waypoint x="516" y="218"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_is_tool_call" bpmnElement="flow_is_tool_call">
        <di:waypoint x="566" y="218"/>
        <di:waypoint x="626" y="220"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_no_tool" bpmnElement="flow_no_tool">
        <di:waypoint x="541" y="243"/>
        <di:waypoint x="541" y="380"/>
        <di:waypoint x="491" y="380"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_check_to_discipline_result" bpmnElement="flow_check_to_discipline_result">
        <di:waypoint x="726" y="220"/>
        <di:waypoint x="786" y="218"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_discipline_blocked" bpmnElement="flow_discipline_blocked">
        <di:waypoint x="811" y="243"/>
        <di:waypoint x="811" y="340"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_discipline_pass" bpmnElement="flow_discipline_pass">
        <di:waypoint x="836" y="218"/>
        <di:waypoint x="896" y="220"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_mark_blocked_to_end" bpmnElement="flow_mark_blocked_to_end">
        <di:waypoint x="861" y="376"/>
        <di:waypoint x="921" y="376"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_inject_to_execute" bpmnElement="flow_inject_to_execute">
        <di:waypoint x="996" y="220"/>
        <di:waypoint x="1056" y="220"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_execute_to_sync" bpmnElement="flow_execute_to_sync">
        <di:waypoint x="1156" y="220"/>
        <di:waypoint x="1216" y="220"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_sync_to_end_tool" bpmnElement="flow_sync_to_end_tool">
        <di:waypoint x="1316" y="220"/>
        <di:waypoint x="1376" y="218"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_flow_generate_to_end" bpmnElement="flow_generate_to_end">
        <di:waypoint x="591" y="376"/>
        <di:waypoint x="651" y="376"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
