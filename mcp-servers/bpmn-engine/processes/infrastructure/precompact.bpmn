<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions
    xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    targetNamespace="http://claude-family/bpmn/precompact"
    id="Definitions_PC">

  <bpmn:process id="precompact" name="PreCompact Hook: Context Preservation" isExecutable="true">

    <!--
      PreCompact hook that preserves critical session state before context compaction.
      Injects a systemMessage with active work items AND narrative context so Claude
      retains both situational awareness and understanding of user intent.

      Trigger: PreCompact event (manual /compact or auto-compact)
      Output: systemMessage injected into post-compact context

      Key behaviors:
        - Queries active todos, session_state, active features from DB
        - Queries session facts (decisions, references, user_intent) from DB
        - Reads session notes from markdown file
        - Builds refresh message with preserved state + narrative
        - Includes post-compaction checklist (recall user_intent, re-read CLAUDE.md)
        - Fail-open: returns minimal message if DB unavailable

      Implementation: scripts/precompact_hook.py
    -->

    <bpmn:startEvent id="start" name="PreCompact Event">
      <bpmn:outgoing>flow_start_project</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:scriptTask id="get_project" name="[TOOL] Get Project Name" scriptFormat="python">
      <bpmn:incoming>flow_start_project</bpmn:incoming>
      <bpmn:outgoing>flow_project_to_db</bpmn:outgoing>
      <bpmn:script>
# project_name = os.path.basename(os.getcwd())
project_name = project_name if project_name is not None else "unknown"
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:scriptTask id="connect_db" name="[DB] Connect to PostgreSQL" scriptFormat="python">
      <bpmn:incoming>flow_project_to_db</bpmn:incoming>
      <bpmn:outgoing>flow_db_to_check</bpmn:outgoing>
      <bpmn:script>
db_available = db_available if db_available is not None else True
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:exclusiveGateway id="db_gw" name="DB Available?" default="flow_no_db">
      <bpmn:incoming>flow_db_to_check</bpmn:incoming>
      <bpmn:outgoing>flow_db_ok</bpmn:outgoing>
      <bpmn:outgoing>flow_no_db</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:scriptTask id="fallback_message" name="[TOOL] Build Fallback Message" scriptFormat="python">
      <bpmn:incoming>flow_no_db</bpmn:incoming>
      <bpmn:outgoing>flow_fallback_to_end</bpmn:outgoing>
      <bpmn:script>
# Minimal message: "Context compaction occurred. Re-read CLAUDE.md."
state_injected = False
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:scriptTask id="query_session_state" name="[DB] Query Active Work Items" scriptFormat="python">
      <bpmn:incoming>flow_db_ok</bpmn:incoming>
      <bpmn:outgoing>flow_query_to_facts</bpmn:outgoing>
      <bpmn:script>
# Query active todos (in_progress first, then pending, limit 10)
# Query session_state (current_focus, next_steps)
# Query active features with task counts
state_queried = True
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:scriptTask id="query_session_facts" name="[DB] Query Session Facts" scriptFormat="python">
      <bpmn:incoming>flow_query_to_facts</bpmn:incoming>
      <bpmn:outgoing>flow_facts_to_notes</bpmn:outgoing>
      <bpmn:script>
# Query session_facts WHERE fact_type IN (decision, reference, note)
# Preserves narrative context: user_intent, decisions, key findings
# Truncates values to 200 chars each, max 5 facts
facts_queried = True
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:scriptTask id="read_session_notes" name="[FILE] Read Session Notes" scriptFormat="python">
      <bpmn:incoming>flow_facts_to_notes</bpmn:incoming>
      <bpmn:outgoing>flow_notes_to_build</bpmn:outgoing>
      <bpmn:script>
# Read ~/.claude/session_notes.md if exists
# Truncate to 500 chars to avoid bloating context
# Contains progress, decisions, blockers, findings sections
notes_read = True
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:scriptTask id="build_message" name="[TOOL] Build Refresh Message" scriptFormat="python">
      <bpmn:incoming>flow_notes_to_build</bpmn:incoming>
      <bpmn:outgoing>flow_build_to_end</bpmn:outgoing>
      <bpmn:script>
# Compose systemMessage with:
# - ACTIVE TODOS (preserved)
# - CURRENT FOCUS and NEXT STEPS
# - ACTIVE FEATURES
# - SESSION CONTEXT (decisions, user_intent)
# - SESSION NOTES (progress, findings)
# - POST-COMPACTION CHECKLIST (recall user_intent, re-read CLAUDE.md)
state_injected = True
      </bpmn:script>
    </bpmn:scriptTask>

    <bpmn:endEvent id="end_injected" name="State Preserved">
      <bpmn:incoming>flow_fallback_to_end</bpmn:incoming>
      <bpmn:incoming>flow_build_to_end</bpmn:incoming>
    </bpmn:endEvent>

    <!-- SEQUENCE FLOWS -->
    <bpmn:sequenceFlow id="flow_start_project" sourceRef="start" targetRef="get_project"/>
    <bpmn:sequenceFlow id="flow_project_to_db" sourceRef="get_project" targetRef="connect_db"/>
    <bpmn:sequenceFlow id="flow_db_to_check" sourceRef="connect_db" targetRef="db_gw"/>
    <bpmn:sequenceFlow id="flow_db_ok" sourceRef="db_gw" targetRef="query_session_state">
      <bpmn:conditionExpression>db_available == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="flow_no_db" sourceRef="db_gw" targetRef="fallback_message"/>
    <bpmn:sequenceFlow id="flow_fallback_to_end" sourceRef="fallback_message" targetRef="end_injected"/>
    <bpmn:sequenceFlow id="flow_query_to_facts" sourceRef="query_session_state" targetRef="query_session_facts"/>
    <bpmn:sequenceFlow id="flow_facts_to_notes" sourceRef="query_session_facts" targetRef="read_session_notes"/>
    <bpmn:sequenceFlow id="flow_notes_to_build" sourceRef="read_session_notes" targetRef="build_message"/>
    <bpmn:sequenceFlow id="flow_build_to_end" sourceRef="build_message" targetRef="end_injected"/>

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="precompact">
      <bpmndi:BPMNShape id="s_start" bpmnElement="start">
        <dc:Bounds x="50" y="200" width="36" height="36"/>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
