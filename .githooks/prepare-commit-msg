#!/bin/bash
# Auto-prepend work item reference from branch name
COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
if [ "$COMMIT_SOURCE" != "" ]; then exit 0; fi
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
if [ -z "$BRANCH" ]; then exit 0; fi
WORK_ITEM=""
if [[ $BRANCH =~ ^feature/(F[0-9]+) ]]; then WORK_ITEM="${BASH_REMATCH[1]}"; fi
if [[ $BRANCH =~ ^fix/(FB[0-9]+) ]]; then WORK_ITEM="${BASH_REMATCH[1]}"; fi
if [[ $BRANCH =~ ^task/(BT[0-9]+) ]]; then WORK_ITEM="${BASH_REMATCH[1]}"; fi
if [ -n "$WORK_ITEM" ]; then
    FIRST_LINE=$(head -n 1 "$COMMIT_MSG_FILE")
    if ! echo "$FIRST_LINE" | grep -qE "^\[$WORK_ITEM\]"; then
        TEMP_FILE=$(mktemp)
        echo "[$WORK_ITEM] $FIRST_LINE" > "$TEMP_FILE"
        tail -n +2 "$COMMIT_MSG_FILE" >> "$TEMP_FILE"
        mv "$TEMP_FILE" "$COMMIT_MSG_FILE"
    fi
fi
exit 0
